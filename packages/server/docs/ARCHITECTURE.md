# TTPolyglot 服务端架构设计

## 项目概述

### 背景
TTPolyglot 是一个多语言翻译管理系统，目前为本地应用。为了支持团队协作、数据同步、用户管理等功能，需要开发对应的服务端系统。

### 目标
构建一个基于 Dart 的 RESTful API 服务端，支持：
- 多用户协作的翻译项目管理
- 细粒度的权限控制
- 数据持久化和同步
- 可扩展的架构设计

## 技术架构

### 后端技术栈
- **语言**: Dart
- **框架**: Shelf + Shelf Router (轻量级 HTTP 服务器)
- **反向代理**: Nginx (HTTP/HTTPS处理，负载均衡，静态文件服务)
- **数据库**: PostgreSQL (容器化部署)
- **ORM**: Drift (原 Moor) - Dart 的类型安全数据库层
- **身份验证**: JWT (JSON Web Tokens)
- **缓存**: Redis (用于会话、API响应和热点数据缓存)
- **容器化**: Docker + Docker Compose
- **监控**: 健康检查端点，系统指标收集
- **日志**: 结构化日志记录和分析
- **API 文档**: OpenAPI 3.0 (Swagger)

### 系统架构图
```
                                           数据流和缓存策略
                    ┌────────────────────────────────────────────────────────────────┐
                    │                                                                │
┌─────────────────┐ │ ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │ ┌─────────────────┐
│  Flutter Client │─┼─│  Nginx Proxy    │───▶│  Dart Server    │───▶│ PostgreSQL DB   │ │ │  Redis Cache    │
│                 │ │ │  (Reverse Proxy)│    │  (Shelf)        │    │   Container     │ │ │   Container     │
│  • 用户会话     │ │ │  • 静态文件缓存  │    │  • 业务逻辑     │    │  • 持久化数据   │ │ │  • 会话存储     │
│  • API 请求     │ │ │  • 请求分发     │    │  • 权限验证     │    │  • 用户数据     │ │ │  • API 响应缓存 │
│  • 界面展示     │ │ │  • 负载均衡     │    │  • 缓存管理     │    │  • 项目数据     │ │ │  • 热点数据     │
└─────────────────┘ │ └─────────────────┘    └─────────────────┘    └─────────────────┘ │ │  • JWT Token    │
         │          │          │                         │                         │    │ │  • 翻译接口配置 │
         │          │          │                         │                         │    │ └─────────────────┘
         │          │          │          ┌──────────────┼─────────────────────────┼────┘          ▲
         │          │          │          │              ▼                         │               │
         │          │          │          │    ┌─────────────────┐                │               │
         │          │          │          │    │   缓存策略：    │                │               │
         │          │          │          │    │                 │                │               │
         │          │          │          │    │ 1.读取时机：    │                │               │
         │          │          │          │    │  • 频繁查询API  │                │               │
         │          │          │          │    │  • 用户会话验证  │               │               │
         │          │          │          │    │  • 翻译接口配置  │               │               │
         │          │          │          │    │  • 项目权限检查  │               │               │
         │          │          │          │    │                 │                │               │
         │          │          │          │    │ 2.写入时机：    │                │               │
         │          │          │          │    │  • 用户登录后   │                │               │
         │          │          │          │    │  • API响应缓存  │                │               │
         │          │          │          │    │  • 配置更新后   │                │               │
         │          │          │          │    │  • 热点数据计算  │               │               │
         │          │          │          │    └─────────────────┘                │               │
         │          │          │          └──────────────────────────────────────┘               │
         │          │          │                                                                   │
         ▼          │          ▼                         ▼                                        │
┌─────────────────┐ │ ┌─────────────────┐    ┌─────────────────┐                                 │
│  Nginx Docker   │ │ │   App Docker    │    │   DB Docker     │ ◄──────────────────────────────┘
│   Container     │ │ │   Container     │    │   Container     │    Redis Docker Container
└─────────────────┘ │ └─────────────────┘    └─────────────────┘    ┌─────────────────┐
         │          │          │                         │           │ Redis Docker    │
         │          │          │                         │           │   Container     │
         │          │          │                         │           │                 │
         │          │          │                         │           │ 缓存场景：      │
         │          │          │                         │           │ • TTL: 1-24小时 │
         │          │          │                         │           │ • 自动过期清理   │
         │          │          │                         │           │ • 集群同步支持   │
         │          │          │                         │           └─────────────────┘
         │          │          │                         │                    │
         │          └──────────┼─────────────────────────┼────────────────────┘
         │                     │                         │
         └─────────────────────┼─────────────────────────┼──────────────────────────────────┐
                               ▼                         ▼                                   │
                    ┌─────────────────────────────────────────────────────────────────────┐ │
                    │                    Docker Network                                    │ │
                    │                    ttpolyglot-net                                    │ │
                    │                                                                     │ │
                    │ 容器间通信：                                                        │ │
                    │ • App ↔ DB: 数据持久化操作                                          │ │
                    │ • App ↔ Redis: 缓存读写操作                                        │ │
                    │ • Nginx ↔ App: HTTP 请求代理                                       │ │
                    └─────────────────────────────────────────────────────────────────────┘ │
                                                     │                                       │
                                                     └───────────────────────────────────────┘
```

## 架构说明

### 组件职责
- **Nginx 反向代理**: 处理HTTP/HTTPS请求，SSL终止，负载均衡，静态文件服务
- **Dart 服务器**: 处理API业务逻辑，身份验证，数据处理，缓存策略管理
- **PostgreSQL**: 持久化数据存储，主数据源
- **Redis 缓存**: 
  - **会话存储**: JWT Token，用户登录状态缓存
  - **API响应缓存**: 频繁查询的数据（如项目列表、用户权限）
  - **热点数据缓存**: 翻译接口配置、系统配置、语言列表
  - **临时数据**: 密码重置token、邮件验证码

### 数据流说明
1. **客户端请求** → Nginx → Dart Server
2. **权限验证** → Dart Server 首先检查 Redis 中的用户会话
3. **数据查询** → Dart Server 优先从 Redis 读取缓存，缓存miss时查询 PostgreSQL
4. **数据更新** → Dart Server 更新 PostgreSQL 后，同步更新或删除 Redis 相关缓存
5. **响应返回** → 新数据缓存到 Redis（如有必要）→ 返回客户端

## 缓存策略

### 多层缓存架构
```
客户端 → Nginx静态缓存 → Redis缓存 → PostgreSQL数据库
```

### Redis缓存使用场景
- **会话管理**: 用户登录状态、JWT Token黑名单
- **权限缓存**: 用户角色权限矩阵，避免每次请求查询数据库
- **配置缓存**: 系统配置、翻译接口配置等相对静态的数据
- **API响应缓存**: GET请求的热点数据（项目列表、语言列表）
- **计算结果缓存**: 统计数据、报告生成结果
- **临时数据**: 验证码、密码重置token、文件上传临时ID

### 缓存更新策略
- **Cache-Aside**: 应用层控制缓存读写
- **Write-Through**: 数据更新时同步更新缓存
- **TTL过期**: 根据数据特性设置合理的过期时间
- **手动失效**: 数据变更时主动删除相关缓存

### 缓存键命名规范
```
user:session:{userId}           # 用户会话
user:permissions:{userId}       # 用户权限
project:list:{userId}          # 用户项目列表
config:system:{key}            # 系统配置
api:response:{endpoint}:{hash} # API响应缓存
temp:reset_token:{token}       # 临时重置token
```

## 安全措施
- SQL 注入防护
- XSS 防护
- CSRF 防护
- 访问频率限制
- 敏感信息加密

## 可扩展性
- 微服务架构准备
- 数据库读写分离
- 缓存层设计
- 消息队列集成
- Nginx 负载均衡配置
- 横向扩展支持

## 监控和日志
- 结构化日志
- 性能指标收集
- 错误追踪
- 健康检查端点
