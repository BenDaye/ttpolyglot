# TTPolyglot å¼€å‘ç¯å¢ƒ Dockerfile
# ç”¨äºå¼€å‘æ—¶çš„çƒ­é‡è½½å’Œä»£ç ç›‘å¬

FROM dart:stable

# å®‰è£…é¢å¤–çš„å¼€å‘å·¥å…·
RUN apt-get update && \
  apt-get install -y --no-install-recommends \
  ca-certificates \
  curl \
  postgresql-client \
  git \
  vim \
  inotify-tools && \
  rm -rf /var/lib/apt/lists/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app/packages/server

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p /app/data /app/logs /app/uploads

# å…ˆå¤åˆ¶ model åŒ…ï¼ˆserver çš„ä¾èµ–ï¼‰
COPY packages/model /app/packages/model

# å¤åˆ¶ pubspec æ–‡ä»¶
COPY packages/server/pubspec.yaml packages/server/pubspec_overrides.yaml ./

# ç§»é™¤ workspace resolution é…ç½®
RUN sed -i '/^resolution: workspace$/d' pubspec.yaml

# é¢„å…ˆå®‰è£…ä¾èµ–ï¼ˆåŠ é€Ÿåç»­å¯åŠ¨ï¼‰
RUN dart pub get

# åˆ›å»º migrate è„šæœ¬çš„ç¬¦å·é“¾æ¥
RUN echo '#!/bin/sh\ncd /app/packages/server && dart run database/migrate.dart "$@"' > /app/migrate && \
  chmod +x /app/migrate

# åˆ›å»ºçƒ­é‡è½½å¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash\n\
  set -e\n\
  \n\
  echo "ğŸ”¥ å¼€å‘æ¨¡å¼ï¼šå¯ç”¨ä»£ç çƒ­é‡è½½"\n\
  echo "ğŸ“ ç›‘å¬ç›®å½•ï¼šlib/ bin/ database/ scripts/"\n\
  echo ""\n\
  \n\
  # ä¿¡å·å¤„ç†å‡½æ•°\n\
  cleanup() {\n\
  echo ""\n\
  echo "ğŸ›‘ æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡..."\n\
  kill $SERVER_PID 2>/dev/null || true\n\
  wait $SERVER_PID 2>/dev/null || true\n\
  exit 0\n\
  }\n\
  \n\
  trap cleanup SIGTERM SIGINT\n\
  \n\
  # å¯åŠ¨æœåŠ¡çš„å‡½æ•°\n\
  start_server() {\n\
  dart run bin/server.dart &\n\
  SERVER_PID=$!\n\
  echo "âœ… æœåŠ¡å·²å¯åŠ¨ (PID: $SERVER_PID)"\n\
  }\n\
  \n\
  # é¦–æ¬¡å¯åŠ¨æœåŠ¡\n\
  start_server\n\
  \n\
  # ç›‘å¬æ–‡ä»¶å˜åŒ–\n\
  while true; do\n\
  # ä½¿ç”¨ inotifywait ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼ˆé˜»å¡ç›´åˆ°æœ‰å˜åŒ–ï¼‰\n\
  if inotifywait -q -r -e modify,create,delete,move --exclude ".*\\.swp|.*~" \\\n\
  lib/ bin/ database/ scripts/ 2>/dev/null; then\n\
  \n\
  echo ""\n\
  echo "ğŸ”„ æ£€æµ‹åˆ°ä»£ç å˜åŒ–ï¼Œé‡å¯æœåŠ¡..."\n\
  \n\
  # æ€æ‰æ—§è¿›ç¨‹\n\
  kill $SERVER_PID 2>/dev/null || true\n\
  wait $SERVER_PID 2>/dev/null || true\n\
  \n\
  # ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œé¿å…é¢‘ç¹é‡å¯\n\
  sleep 1\n\
  \n\
  # é‡æ–°å¯åŠ¨æœåŠ¡\n\
  start_server\n\
  else\n\
  # å¦‚æœ inotifywait å¤±è´¥ï¼Œç­‰å¾…åé‡è¯•\n\
  sleep 2\n\
  fi\n\
  done' > /app/hot-reload.sh && \
  chmod +x /app/hot-reload.sh

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1

# å¼€å‘ç¯å¢ƒä½¿ç”¨çƒ­é‡è½½è„šæœ¬å¯åŠ¨
CMD ["/app/hot-reload.sh"]

